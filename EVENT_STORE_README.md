# Event Store —Å –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–º —Ö—Ä–∞–Ω–µ–Ω–∏–µ–º

–°–∏—Å—Ç–µ–º–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –≤–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º–æ—Å—Ç–∏ –ø–æ—Ç–æ–∫–æ–≤ –≤ MCP (Model Context Protocol) —Å –ø–æ–ª–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è.

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

- **`event_store.py`** - –û—Å–Ω–æ–≤–Ω—ã–µ –∫–ª–∞—Å—Å—ã —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ (InMemory + Persistent)
- **`event_store_config.py`** - –°–∏—Å—Ç–µ–º–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏–π
- **`event_store_migrations.py`** - –£—Ç–∏–ª–∏—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è, –±—ç–∫–∞–ø—ã, –º–∏–≥—Ä–∞—Ü–∏–∏
- **`example_event_store.py`** - –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è

### –¢–∏–ø—ã —Ö—Ä–∞–Ω–∏–ª–∏—â

#### 1. InMemoryEventStore
- –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º
- –î–∞–Ω–Ω—ã–µ —Ç–µ—Ä—è—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ

#### 2. PersistentEventStore
- –î–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- SQLite –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- Hybrid –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –ø–∞–º—è—Ç–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Å–æ–±—ã—Ç–∏–π

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –ë–∞–∑–æ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```python
from event_store import create_event_store
from event_store_config import get_config

# –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
config = get_config("production")

# –°–æ–∑–¥–∞–µ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
store = create_event_store(
    persistent=config.persistent,
    db_path=config.db_path,
    max_events_per_stream=config.max_events_per_stream
)

# –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–±—ã—Ç–∏–µ
event_id = await store.store_event("stream_1", {
    "method": "tools/call",
    "params": {"name": "calculator", "args": {"a": 5, "b": 3}}
})

# –ü–µ—Ä–µ–∏–≥—Ä—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è –ø–æ—Å–ª–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ ID
async def handle_event(event_message):
    print(f"–°–æ–±—ã—Ç–∏–µ: {event_message.message}")

await store.replay_events_after(last_event_id, handle_event)
```

### –ó–∞–ø—É—Å–∫ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏

```bash
python example_event_store.py
```

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

```python
from event_store_config import get_config

# –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (in-memory)
config = get_config("development")

# –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (SQLite –≤ –ø–∞–º—è—Ç–∏)
config = get_config("testing")

# –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ (—Ñ–∞–π–ª–æ–≤–∞—è SQLite)
config = get_config("production")

# –ò–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
config = get_config("from_env")
```

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
EVENT_STORE_PERSISTENT=true
EVENT_STORE_DB_PATH=InternalStorage/events.db
EVENT_STORE_MAX_EVENTS=1000
EVENT_STORE_RETENTION_DAYS=30
EVENT_STORE_CACHE_SIZE=100
EVENT_STORE_BACKUP_ENABLED=true
EVENT_STORE_BACKUP_INTERVAL=24
EVENT_STORE_BACKUP_RETENTION=7
```

## üõ†Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ

### –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–æ–≤

```python
from event_store_migrations import EventStoreManager

manager = EventStoreManager("InternalStorage/events.db")

# –°–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø
backup_path = manager.create_backup()

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –±—ç–∫–∞–ø–∞
manager.restore_from_backup("path/to/backup.db")

# –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –±—ç–∫–∞–ø—ã
deleted_count = manager.cleanup_old_backups(retention_days=7)
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

```python
# –ë–∞–∑–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
stats = store.get_stream_stats()
print(f"–ü–æ—Ç–æ–∫–∏: {stats}")

# –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–¥–ª—è PersistentEventStore)
db_info = store.get_database_info()
print(f"–†–∞–∑–º–µ—Ä –ë–î: {db_info['database_size_mb']} MB")

# –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
detailed_stats = manager.get_database_stats()
```

### –í–∞–ª–∏–¥–∞—Ü–∏—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏

```python
validation = manager.validate_database()

if validation['valid']:
    print("‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≤–∞–ª–∏–¥–Ω–∞")
else:
    print("‚ùå –û—à–∏–±–∫–∏:")
    for error in validation['errors']:
        print(f"  - {error}")
```

### –≠–∫—Å–ø–æ—Ä—Ç –∏ –∏–º–ø–æ—Ä—Ç

```python
# –≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π
count = manager.export_events("backup.json")

# –≠–∫—Å–ø–æ—Ä—Ç —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π
count = manager.export_events(
    "filtered.json",
    stream_id="specific_stream",
    start_date="2024-01-01T00:00:00",
    end_date="2024-12-31T23:59:59"
)

# –ò–º–ø–æ—Ä—Ç —Å–æ–±—ã—Ç–∏–π
count = manager.import_events("backup.json")
```

## üîß –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ PersistentEventStore

1. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–º–∏
2. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - hybrid –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
3. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Å–æ–±—ã—Ç–∏–π
4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –¥–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è
5. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—ç–∫–∞–ø—ã –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ

### Hybrid –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

- **–ö—ç—à –≤ –ø–∞–º—è—Ç–∏**: –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–æ–±—ã—Ç–∏–π –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
- **SQLite –±–∞–∑–∞**: –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è**: –º–µ–∂–¥—É –∫—ç—à–µ–º –∏ –ë–î
- **Graceful fallback**: –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∫—ç—à–∞ –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ –ë–î

### –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```sql
CREATE TABLE events (
    event_id TEXT PRIMARY KEY,
    stream_id TEXT NOT NULL,
    message_json TEXT NOT NULL,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
CREATE INDEX idx_stream_timestamp ON events(stream_id, timestamp);
CREATE INDEX idx_timestamp ON events(timestamp);
```

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –º–µ—Ç—Ä–∏–∫–∏

### –î–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏

- –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–±—ã—Ç–∏–π
- –°–æ–±—ã—Ç–∏—è –ø–æ –ø–æ—Ç–æ–∫–∞–º
- –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–∞–º–∫–∏ (–ø–µ—Ä–≤–æ–µ/–ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–±—ã—Ç–∏–µ)
- –†–∞–∑–º–µ—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫—ç—à–∞

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ

```python
from event_store_migrations import run_maintenance_tasks

# –ó–∞–ø—É—Å–∫ –∑–∞–¥–∞—á –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è
results = await run_maintenance_tasks(
    "InternalStorage/events.db",
    config.__dict__
)

print(f"–†–µ–∑—É–ª—å—Ç–∞—Ç—ã: {results}")
```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

- Graceful handling –æ—Ç–∫–ª—é—á–µ–Ω–∏–π –ë–î
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- Fallback –∫ –∫—ç—à—É –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –ë–î
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

### –¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- –í–∞–ª–∏–¥–∞—Ü–∏—è JSON —Å–æ–æ–±—â–µ–Ω–∏–π
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ SQLite
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π

### –ë—ç–∫–∞–ø—ã

- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é
- –†–æ—Ç–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤
- –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –∫–æ–ø–∏–∏
- –ë—ã—Å—Ç—Ä–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ

## üìã –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```txt
aiosqlite>=0.19.0    # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π SQLite
mcp>=0.1.0           # Model Context Protocol
```

### –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- **RAM**: 100MB –¥–ª—è –∫—ç—à–∞ (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è)
- **–î–∏—Å–∫**: –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–æ–±—ã—Ç–∏–π (~1KB –Ω–∞ —Å–æ–±—ã—Ç–∏–µ)
- **CPU**: –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –¥–ª—è SQLite –æ–ø–µ—Ä–∞—Ü–∏–π

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é "testing":

```python
config = get_config("testing")  # SQLite –≤ –ø–∞–º—è—Ç–∏
store = create_event_store(**config.__dict__)
```

## üöÄ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

- –ò–Ω–¥–µ–∫—Å—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–±—ã—Ç–∏–π –≤ –ø–∞–º—è—Ç–∏
- Batch –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö –≤—Å—Ç–∞–≤–æ–∫
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ë–î

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π—Ç–µ `memory_cache_size` –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–æ—Å—Ç—É–ø–Ω–æ–π RAM
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ `retention_days` —Å–æ–≥–ª–∞—Å–Ω–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º
- –í–∫–ª—é—á–∏—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—ç–∫–∞–ø—ã
- –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ —Ä–∞–∑–º–µ—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [MCP Specification](https://modelcontextprotocol.io/)
- [SQLite Documentation](https://sqlite.org/docs.html)
- [–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è](example_event_store.py)